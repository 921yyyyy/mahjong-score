<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HISTORY | Professional Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        body { background-color: #070d1c; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .game-card { background: linear-gradient(180deg, #161e2d 0%, #0a0f1a 100%); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.7); }
        .swiper { width: 100%; padding-top: 30px; padding-bottom: 50px; }
        .swiper-slide { width: 320px; opacity: 0.3; transition: opacity 0.4s ease; }
        .swiper-slide-active { opacity: 1; }
        .score-font { font-family: 'Roboto Mono', monospace; }
        .rank-gold { color: #facc15; }
        .rank-silver { color: #cbd5e1; }
        .list-item-card { background: rgba(255, 255, 255, 0.03); border-left: 3px solid #f97316; }

        /* モーダルアニメーション */
        #detail-modal { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(100%); }
        #detail-modal.active { transform: translateY(0); }
    </style>
</head>
<body class="pb-24">
    <div class="max-w-4xl mx-auto p-4">
        <header class="mb-10 pt-6">
            <span class="text-[10px] text-orange-500 font-black tracking-[0.3em] uppercase block mb-1">Data Archive</span>
            <h1 class="text-3xl font-black italic uppercase tracking-tighter border-b-2 border-orange-500 inline-block leading-none pb-1">Session History</h1>
        </header>

        <section class="mb-12">
            <div class="swiper mySwiper">
                <div class="swiper-wrapper" id="history-swiper-wrapper"></div>
                <div class="swiper-pagination"></div>
            </div>
        </section>

        <section>
            <h2 class="text-[10px] font-bold text-slate-500 mb-6 uppercase tracking-[0.2em] px-2 border-l-2 border-orange-500 ml-2">All Logs</h2>
            <div id="history-list" class="space-y-6 px-2"></div>
        </section>
    </div>

    <div id="detail-modal" class="fixed inset-0 z-50 bg-[#070d1c] overflow-y-auto">
        <div class="sticky top-0 bg-[#070d1c]/90 backdrop-blur-md p-4 border-b border-white/10 flex justify-between items-center">
            <div>
                <span id="modal-date" class="text-[10px] text-orange-500 font-bold uppercase">DATE</span>
                <h2 class="text-xl font-black italic uppercase tracking-tighter">Box Score</h2>
            </div>
            <button onclick="closeModal()" class="text-slate-400 hover:text-white bg-white/5 w-10 h-10 rounded-full flex items-center justify-center font-bold">×</button>
        </div>
        
        <div id="modal-content" class="p-4 space-y-8">
            </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="navbar.js"></script>

    <script>
        const S_URL = 'https://zekfibkimvsfbnctwzti.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpla2ZpYmtpbXZzZmJuY3R3enRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODU5NjYsImV4cCI6MjA4NDE2MTk2Nn0.AjW_4HvApe80USaHTAO_P7WeWaQvPo3xi3cpHm4hrFs';
        const sb = window.supabase.createClient(S_URL, S_KEY);

        async function initHistory() {
            try {
                const { data: sessionData, error } = await sb.from('set_summaries').select('*').order('created_at', { ascending: false });
                if (error) throw error;

                const sessions = {};
                sessionData.forEach(row => {
                    const d = new Date(row.created_at).toLocaleDateString('ja-JP', { year:'numeric', month:'2-digit', day:'2-digit' });
                    if (!sessions[d]) sessions[d] = [];
                    sessions[d].push(row);
                });

                const swiperWrapper = document.getElementById('history-swiper-wrapper');
                const historyList = document.getElementById('history-list');

                Object.keys(sessions).forEach((date, index) => {
                    const players = sessions[date].sort((a,b) => a.final_rank - b.final_rank);
                    const cardHtml = createSessionCard(players, date);

                    if (index < 5) {
                        const slide = document.createElement('div');
                        slide.className = 'swiper-slide';
                        slide.innerHTML = cardHtml;
                        swiperWrapper.appendChild(slide);
                    }
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item-card p-4 rounded-r-lg';
                    listItem.innerHTML = cardHtml;
                    historyList.appendChild(listItem);
                });

                new Swiper(".mySwiper", {
                    effect: "coverflow",
                    centeredSlides: true,
                    slidesPerView: "auto",
                    coverflowEffect: { rotate: 35, stretch: 0, depth: 100, modifier: 1, slideShadows: false },
                    pagination: { el: ".swiper-pagination", clickable: true },
                });
            } catch (e) { console.error(e); }
        }

        function createSessionCard(players, date) {
            // session_idがあればそれを使う、なければ日付をキーにする
            const sId = players[0].session_id || date;
            return `
                <div class="game-card p-5" onclick="showSessionDetail('${sId}', '${date}')">
                    <div class="flex justify-between items-start mb-5">
                        <div>
                            <span class="text-[9px] text-orange-500 font-black tracking-widest uppercase">Daily Result</span>
                            <h3 class="text-xl font-black italic tracking-tighter leading-none">${date}</h3>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${players.map(p => `
                            <div class="flex items-center justify-between border-b border-white/5 pb-1">
                                <div class="flex items-center space-x-3">
                                    <span class="text-base font-black italic w-4 ${p.final_rank === 1 ? 'rank-gold' : 'text-slate-500'}">${p.final_rank}</span>
                                    <span class="text-xs font-bold text-slate-200">${p.player_name}</span>
                                </div>
                                <span class="text-sm score-font font-black ${p.total_score >= 0 ? 'text-blue-400' : 'text-red-400'}">
                                    ${p.total_score > 0 ? '+' : ''}${p.total_score}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        window.showSessionDetail = async function(sId, date) {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            const dateLabel = document.getElementById('modal-date');
            
            dateLabel.innerText = date;
            content.innerHTML = "<div class='p-10 text-center animate-pulse'>LOADING MATCH DATA...</div>";
            modal.classList.add('active');

            try {
                // そのSessionに関連する半荘（Match）データを取得
                // session_idで紐付け。ない場合は日付でフィルタ
                let query = sb.from('game_results').select('*');
                if (sId.includes('/')) { // 日付形式の場合
                    const start = new Date(date).toISOString();
                    const end = new Date(new Date(date).getTime() + 86400000).toISOString();
                    query = query.gte('created_at', start).lt('created_at', end);
                } else {
                    query = query.eq('session_id', sId);
                }

                const { data: matches, error } = await query.order('created_at', { ascending: true });
                if (error) throw error;

                // match_idごとにグループ化
                const grouped = {};
                matches.forEach(m => {
                    const mId = m.match_id || m.created_at;
                    if(!grouped[mId]) grouped[mId] = [];
                    grouped[mId].push(m);
                });

                content.innerHTML = "";
                Object.keys(grouped).forEach((mId, i) => {
                    const players = grouped[mId].sort((a,b) => a.rank - b.rank);
                    const matchCard = `
                        <div class="bg-white/5 rounded-lg overflow-hidden border border-white/10">
                            <div class="bg-white/10 px-4 py-2 flex justify-between items-center">
                                <span class="text-[10px] font-black uppercase tracking-widest text-orange-400">Match #${i+1}</span>
                            </div>
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="text-[8px] text-slate-500 uppercase border-b border-white/5">
                                        <th class="p-3">Rank</th>
                                        <th class="p-3">Player</th>
                                        <th class="p-3 text-right">Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${players.map(p => `
                                        <tr class="border-b border-white/5 last:border-0">
                                            <td class="p-3 text-lg font-black italic ${p.rank==1?'rank-gold':''}">${p.rank}</td>
                                            <td class="p-3 text-xs font-bold">${p.player_name}</td>
                                            <td class="p-3 text-right font-mono font-bold ${p.score>=0?'text-blue-400':'text-red-400'}">${p.score>0?'+':''}${p.score}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>`;
                    content.innerHTML += matchCard;
                });

            } catch (e) { content.innerHTML = "ERROR LOADING DATA"; }
        }

        window.closeModal = function() {
            document.getElementById('detail-modal').classList.remove('active');
        }

        initHistory();
    </script>
</body>
</html>
