<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€ã‚·ãƒ¼ãƒˆDX-Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <style>
        /* 1äººã‚ãŸã‚Š2åˆ—(+,-) Ã— 4äºº + å›æ•°(3rem) */
        .score-grid { 
            display: grid;
            grid-template-columns: 2.5rem repeat(4, 1fr); 
            gap: 2px;
        }
        .player-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-100 pb-20 text-gray-800">

    <div class="max-w-2xl mx-auto bg-white shadow-xl min-h-screen">
        <div class="bg-green-800 p-4 text-white">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-lg font-bold">ğŸ€„ ã‚¹ã‚³ã‚¢è¨˜éŒ²å¸³ (2åˆ—å½¢å¼)</h1>
                <input type="text" id="setName" placeholder="1/16 å‹äººå®…" class="bg-green-900 text-sm border-none rounded px-2 py-1 w-32 outline-none">
            </div>
            <div class="flex gap-2 items-center bg-green-700 p-2 rounded text-xs">
                <span>ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³:</span>
                <input type="file" id="imageInput" accept="image/*" class="flex-1">
            </div>
        </div>

        <div class="score-grid bg-gray-200 p-1 border-b sticky top-0 z-10">
            <div class="flex items-center justify-center text-[10px] font-bold">å›</div>
            <div class="player-col"><div class="col-span-2 text-center border-b border-gray-400">A</div><div class="text-[9px] bg-blue-50">+</div><div class="text-[9px] bg-red-50">-</div></div>
            <div class="player-col"><div class="col-span-2 text-center border-b border-gray-400">B</div><div class="text-[9px] bg-blue-50">+</div><div class="text-[9px] bg-red-50">-</div></div>
            <div class="player-col"><div class="col-span-2 text-center border-b border-gray-400">C</div><div class="text-[9px] bg-blue-50">+</div><div class="text-[9px] bg-red-50">-</div></div>
            <div class="player-col"><div class="col-span-2 text-center border-b border-gray-400">D</div><div class="text-[9px] bg-blue-50">+</div><div class="text-[9px] bg-red-50">-</div></div>
        </div>

        <div id="scoreRows" class="p-1 space-y-1">
            </div>

        <div class="p-4 bg-yellow-50 border-t-2 border-yellow-200 sticky bottom-0">
            <div class="score-grid mb-4">
                <div class="flex items-center justify-center font-bold text-xs italic">è¨ˆ</div>
                <div id="totalA" class="text-center font-mono font-bold text-sm">0</div>
                <div id="totalB" class="text-center font-mono font-bold text-sm">0</div>
                <div id="totalC" class="text-center font-mono font-bold text-sm">0</div>
                <div id="totalD" class="text-center font-mono font-bold text-sm">0</div>
            </div>
            <div class="flex gap-2">
                <button onclick="clearBoard()" class="flex-1 bg-gray-200 py-3 rounded-xl font-bold text-sm">ã‚¯ãƒªã‚¢</button>
                <button onclick="saveSheet()" class="flex-[2] bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg">ã‚·ãƒ¼ãƒˆã‚’ä¿å­˜</button>
            </div>
        </div>

        <div id="historyList" class="p-4 space-y-3 bg-gray-50"></div>
    </div>

    <script>
        const repo = "921yyyyy/mahjong-score";
        const path = "data.json";

        // è¡Œã®ç”Ÿæˆ
        const scoreRows = document.getElementById('scoreRows');
        for (let i = 1; i <= 8; i++) {
            const row = document.createElement('div');
            row.className = 'score-grid items-center border-b border-gray-50 pb-1';
            row.innerHTML = `
                <div class="text-center font-mono text-xs text-gray-400">${i}</div>
                ${[1,2,3,4].map(p => `
                    <div class="player-col items-center">
                        <input type="number" class="p${p}-plus r${i} w-full text-center text-sm p-1 bg-blue-50 rounded-l border-r border-white outline-none focus:bg-blue-100" placeholder="0" oninput="onInputChange(${i}, ${p})">
                        <input type="number" class="p${p}-minus r${i} w-full text-center text-sm p-1 bg-red-50 rounded-r outline-none focus:bg-red-100" placeholder="0" oninput="onInputChange(${i}, ${p})">
                    </div>
                `).join('')}
                <div class="col-start-2 col-span-4 flex justify-end px-1">
                    <button onclick="assistZero(${i})" class="text-[9px] bg-white border border-gray-300 px-2 py-0.5 rounded shadow-sm text-gray-500 mt-0.5">æ®‹ã‚Šã‚’è‡ªå‹•å…¥åŠ›</button>
                </div>
            `;
            scoreRows.appendChild(row);
        }

        // å…¥åŠ›æ™‚ã®å‡¦ç†
        function onInputChange(rowIdx, pIdx) {
            calcTotals();
        }

        // åˆè¨ˆ0ã‚¢ã‚·ã‚¹ãƒˆ
        function assistZero(rowIdx) {
            const rowScores = [1,2,3,4].map(p => {
                const plus = parseInt(document.querySelector(`.p${p}-plus.r${rowIdx}`).value) || 0;
                const minus = parseInt(document.querySelector(`.p${p}-minus.r${rowIdx}`).value) || 0;
                return plus - minus;
            });
            const filledCount = rowScores.filter(s => s !== 0).length;
            const currentSum = rowScores.reduce((a, b) => a + b, 0);
            
            if (currentSum === 0) return;

            // æœªå…¥åŠ›ã®1äººã‚’æ¢ã™
            for(let p=1; p<=4; p++) {
                const pVal = parseInt(document.querySelector(`.p${p}-plus.r${rowIdx}`).value) || 
                             parseInt(document.querySelector(`.p${p}-minus.r${rowIdx}`).value) || 0;
                if (pVal === 0) {
                    const diff = -currentSum;
                    if (diff > 0) document.querySelector(`.p${p}-plus.r${rowIdx}`).value = diff;
                    else document.querySelector(`.p${p}-minus.r${rowIdx}`).value = Math.abs(diff);
                    break;
                }
            }
            calcTotals();
        }

        function calcTotals() {
            [1,2,3,4].forEach(p => {
                let pTotal = 0;
                for(let i=1; i<=8; i++) {
                    const plus = parseInt(document.querySelector(`.p${p}-plus.r${i}`).value) || 0;
                    const minus = parseInt(document.querySelector(`.p${p}-minus.r${i}`).value) || 0;
                    pTotal += (plus - minus);
                }
                const el = document.getElementById(`total${'ABCD'[p-1]}`);
                el.innerText = (pTotal > 0 ? '+' : '') + pTotal;
                el.className = `text-center font-mono font-bold text-sm ${pTotal >= 0 ? 'text-blue-600' : 'text-red-500'}`;
            });
        }

        async function saveSheet() {
            const token = prompt("GitHubãƒˆãƒ¼ã‚¯ãƒ³"); if (!token) return;
            const data = [];
            for (let i = 1; i <= 8; i++) {
                const row = [1,2,3,4].map(p => {
                    const plus = parseInt(document.querySelector(`.p${p}-plus.r${i}`).value) || 0;
                    const minus = parseInt(document.querySelector(`.p${p}-minus.r${i}`).value) || 0;
                    return plus - minus;
                });
                if (row.some(v => v !== 0)) data.push(row);
            }
            const newSheet = { id: Date.now(), date: new Date().toLocaleString('ja-JP'), name: document.getElementById('setName').value || "ç„¡é¡Œ", data };
            
            // ... (ä¿å­˜å‡¦ç†ã¯ä»¥å‰ã¨åŒã˜)
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers: { "Authorization": `token ${token}` } });
                const fData = await res.json();
                let content = JSON.parse(decodeURIComponent(escape(atob(fData.content))));
                content.push(newSheet);
                await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Save sheet", content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))), sha: fData.sha })
                });
                alert("ä¿å­˜å®Œäº†ï¼"); location.reload();
            } catch (e) { alert(e.message); }
        }

        function clearBoard() { if(confirm("ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) location.reload(); }

        window.onload = async () => {
            const list = document.getElementById('historyList');
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`);
                const fData = await res.json();
                const data = JSON.parse(decodeURIComponent(escape(atob(fData.content))));
                list.innerHTML = data.reverse().map(s => `<div class="bg-white p-3 rounded shadow-sm text-xs"><b>${s.name}</b> (${s.date})</div>`).join('');
            } catch(e) {}
        };
    </script>
</body>
</html>
