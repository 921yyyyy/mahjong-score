<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€ã‚·ãƒ¼ãƒˆDX-Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <style>
        .score-grid { 
            display: grid;
            grid-template-columns: 2.5rem repeat(4, 1fr); 
            gap: 2px;
        }
        .player-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-100 pb-20 text-gray-800">

    <div class="max-w-2xl mx-auto bg-white shadow-xl min-h-screen">
        <div class="bg-green-800 p-4 text-white">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-lg font-bold">ğŸ€„ ã‚¹ã‚³ã‚¢è¨˜éŒ²å¸³ (2åˆ—å½¢å¼)</h1>
                <input type="text" id="setName" placeholder="1/16 å‹äººå®…" class="bg-green-900 text-sm border-none rounded px-2 py-1 w-32 outline-none">
            </div>
            <div class="flex gap-2 items-center bg-green-700 p-2 rounded text-xs">
                <span>ğŸ“· è§£æ:</span>
                <input type="file" id="imageInput" accept="image/*" class="flex-1">
            </div>
            <div id="status" class="text-[10px] text-yellow-200 mt-1 hidden italic">è§£æä¸­... 10ç§’ã»ã©ãŠå¾…ã¡ãã ã•ã„</div>
        </div>

        <div class="score-grid bg-gray-200 p-1 border-b sticky top-0 z-10">
            <div class="flex items-center justify-center text-[10px] font-bold">å›</div>
            <div class="player-col"><div class="col-span-2 text-center border-b border-gray-400 font-bold">A</div><div class="text-[9px] bg-blue-50 text-center">+</div><div class="text-[9px] bg-red-50 text-center">-</div></div>
            <div class="player-col"><div class="col-span-2 text-center border-b border-gray-400 font-bold">B</div><div class="text-[9px] bg-blue-50 text-center">+</div><div class="text-[9px] bg-red-50 text-center">-</div></div>
            <div class="player-col"><div class="col-span-2 text-center border-b border-gray-400 font-bold">C</div><div class="text-[9px] bg-blue-50 text-center">+</div><div class="text-[9px] bg-red-50 text-center">-</div></div>
            <div class="player-col"><div class="col-span-2 text-center border-b border-gray-400 font-bold">D</div><div class="text-[9px] bg-blue-50 text-center">+</div><div class="text-[9px] bg-red-50 text-center">-</div></div>
        </div>

        <div id="scoreRows" class="p-1 space-y-1"></div>

        <div class="p-4 bg-yellow-50 border-t-2 border-yellow-200 sticky bottom-0">
            <div class="score-grid mb-4">
                <div class="flex items-center justify-center font-bold text-xs italic">è¨ˆ</div>
                <div id="totalA" class="text-center font-mono font-bold text-sm">0</div>
                <div id="totalB" class="text-center font-mono font-bold text-sm">0</div>
                <div id="totalC" class="text-center font-mono font-bold text-sm">0</div>
                <div id="totalD" class="text-center font-mono font-bold text-sm">0</div>
            </div>
            <div class="flex gap-2">
                <button onclick="clearBoard()" class="flex-1 bg-gray-200 py-3 rounded-xl font-bold text-sm">ã‚¯ãƒªã‚¢</button>
                <button onclick="saveSheet()" class="flex-[2] bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg">ã‚·ãƒ¼ãƒˆã‚’ä¿å­˜</button>
            </div>
        </div>

        <div id="historyList" class="p-4 space-y-3 bg-gray-50"></div>
    </div>

    <script>
        const repo = "921yyyyy/mahjong-score";
        const path = "data.json";

        // è¡Œã®ç”Ÿæˆ
        const scoreRows = document.getElementById('scoreRows');
        for (let i = 1; i <= 8; i++) {
            const row = document.createElement('div');
            row.className = 'score-grid items-center border-b border-gray-50 pb-1';
            row.innerHTML = `
                <div class="text-center font-mono text-xs text-gray-400">${i}</div>
                ${[1,2,3,4].map(p => `
                    <div class="player-col items-center">
                        <input type="number" class="p${p}-plus r${i} w-full text-center text-sm p-1.5 bg-blue-50 rounded-l border-r border-white outline-none focus:bg-blue-100" placeholder="0" oninput="calcTotals()">
                        <input type="number" class="p${p}-minus r${i} w-full text-center text-sm p-1.5 bg-red-50 rounded-r outline-none focus:bg-red-100" placeholder="0" oninput="calcTotals()">
                    </div>
                `).join('')}
                <div class="col-start-2 col-span-4 flex justify-end px-1">
                    <button onclick="assistZero(${i})" class="text-[9px] bg-white border border-gray-300 px-2 py-0.5 rounded shadow-sm text-gray-500 mt-0.5">æ®‹ã‚Šã‚’è‡ªå‹•å…¥åŠ›</button>
                </div>
            `;
            scoreRows.appendChild(row);
        }

        // --- OCRï¼ˆè§£æï¼‰å‡¦ç†ã®è¿½åŠ  ---
        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const status = document.getElementById('status');
            status.classList.remove('hidden');

            try {
                // Tesseractã§ç”»åƒå†…ã®å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’èªè­˜
                const { data: { text } } = await Tesseract.recognize(file, 'eng');
                // æ•°å­—ï¼ˆ1ã€œ3æ¡ç¨‹åº¦ï¼‰ã ã‘ã‚’å–ã‚Šå‡ºã™
                const numbers = text.match(/\d+/g)?.map(Number) || [];
                
                // å…¨å…¥åŠ›æ¬„ï¼ˆãƒ—ãƒ©ã‚¹ã¨ãƒã‚¤ãƒŠã‚¹ãŒäº¤äº’ã«ä¸¦ã¶ï¼‰ã‚’å–å¾—
                const allInputs = document.querySelectorAll('#scoreRows input');
                
                // èª­ã¿å–ã£ãŸé †ã«æµã—è¾¼ã‚€
                numbers.forEach((num, index) => {
                    if (index < allInputs.length) {
                        allInputs[index].value = num;
                    }
                });

                status.innerText = "è§£æå®Œäº†ï¼";
                setTimeout(() => status.classList.add('hidden'), 3000);
                calcTotals();
            } catch (err) {
                alert("è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                status.classList.add('hidden');
            }
        });

        function calcTotals() {
            [1,2,3,4].forEach(p => {
                let pTotal = 0;
                for(let i=1; i<=8; i++) {
                    const plus = parseInt(document.querySelector(`.p${p}-plus.r${i}`).value) || 0;
                    const minus = parseInt(document.querySelector(`.p${p}-minus.r${i}`).value) || 0;
                    pTotal += (plus - minus);
                }
                const el = document.getElementById(`total${'ABCD'[p-1]}`);
                el.innerText = (pTotal > 0 ? '+' : '') + pTotal;
                el.className = `text-center font-mono font-bold text-sm ${pTotal >= 0 ? 'text-blue-600' : 'text-red-500'}`;
            });
        }

        function assistZero(rowIdx) {
            const rowScores = [1,2,3,4].map(p => {
                const plus = parseInt(document.querySelector(`.p${p}-plus.r${rowIdx}`).value) || 0;
                const minus = parseInt(document.querySelector(`.p${p}-minus.r${rowIdx}`).value) || 0;
                return plus - minus;
            });
            const currentSum = rowScores.reduce((a, b) => a + b, 0);
            if (currentSum === 0) return;

            for(let p=1; p<=4; p++) {
                const plusVal = document.querySelector(`.p${p}-plus.r${rowIdx}`).value;
                const minusVal = document.querySelector(`.p${p}-minus.r${rowIdx}`).value;
                if (!plusVal && !minusVal) {
                    const diff = -currentSum;
                    if (diff > 0) document.querySelector(`.p${p}-plus.r${rowIdx}`).value = diff;
                    else document.querySelector(`.p${p}-minus.r${rowIdx}`).value = Math.abs(diff);
                    break;
                }
            }
            calcTotals();
        }

        async function saveSheet() {
            const token = prompt("GitHubãƒˆãƒ¼ã‚¯ãƒ³"); if (!token) return;
            const data = [];
            for (let i = 1; i <= 8; i++) {
                const row = [1,2,3,4].map(p => {
                    const plus = parseInt(document.querySelector(`.p${p}-plus.r${i}`).value) || 0;
                    const minus = parseInt(document.querySelector(`.p${p}-minus.r${i}`).value) || 0;
                    return plus - minus;
                });
                if (row.some(v => v !== 0)) data.push(row);
            }
            const newSheet = { id: Date.now(), date: new Date().toLocaleString('ja-JP'), name: document.getElementById('setName').value || "ç„¡é¡Œ", data };
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers: { "Authorization": `token ${token}` } });
                const fData = await res.json();
                let content = JSON.parse(decodeURIComponent(escape(atob(fData.content))));
                content.push(newSheet);
                await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Save sheet", content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))), sha: fData.sha })
                });
                alert("ä¿å­˜å®Œäº†ï¼"); location.reload();
            } catch (e) { alert(e.message); }
        }

        function clearBoard() { if(confirm("ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) location.reload(); }

        window.onload = async () => {
            const list = document.getElementById('historyList');
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`);
                const fData = await res.json();
                const data = JSON.parse(decodeURIComponent(escape(atob(fData.content))));
                list.innerHTML = `<h2 class="text-xs font-bold text-gray-500 mb-2">æœ€è¿‘ã®å±¥æ­´</h2>` + 
                    data.reverse().slice(0, 5).map(s => `<div class="bg-white p-2 rounded shadow-sm text-[10px] border-l-2 border-green-600"><b>${s.name}</b> <span class="text-gray-400">(${s.date})</span></div>`).join('');
            } catch(e) {}
        };
    </script>
</body>
</html>
