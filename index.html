<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€ã‚·ãƒ¼ãƒˆDX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <style>
        .score-grid { grid-template-columns: 3rem 1fr 1fr 1fr 1fr; }
    </style>
</head>
<body class="bg-gray-100 p-2 pb-20 text-gray-800">

    <div class="max-w-2xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden mb-6">
        <div class="bg-green-700 p-4 text-white flex justify-between items-center">
            <h1 class="text-xl font-bold">ğŸ€„ ã‚¹ã‚³ã‚¢è¨˜éŒ²å¸³</h1>
            <input type="text" id="setName" placeholder="ã‚»ãƒƒãƒˆåï¼ˆä¾‹ï¼š1/16 å‹äººå®…ï¼‰" class="bg-green-800 text-sm border-none rounded px-2 py-1 text-white placeholder-green-300 w-1/2">
        </div>

        <div class="p-3 border-b bg-green-50 flex gap-2">
            <div class="flex-1">
                <label class="block text-[10px] font-bold text-green-700">ğŸ“· ã‚·ãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³</label>
                <input type="file" id="imageInput" accept="image/*" class="text-xs w-full">
            </div>
            <button onclick="clearBoard()" class="text-xs bg-gray-200 px-2 rounded">ã‚¯ãƒªã‚¢</button>
        </div>

        <div id="status" class="text-center text-blue-600 py-1 text-[10px] hidden italic bg-blue-50">è§£æä¸­...</div>

        <div class="p-2">
            <div class="score-grid grid gap-1 text-center font-bold text-xs border-b pb-1 mb-1 bg-gray-100 p-1">
                <div>å›</div><div>A</div><div>B</div><div>C</div><div>D</div>
            </div>
            <div id="scoreRows" class="space-y-1">
                </div>
            <div class="score-grid grid gap-1 text-center font-bold text-sm mt-2 p-1 bg-yellow-50 border-t-2 border-yellow-200">
                <div class="text-[10px] flex items-center justify-center">è¨ˆ</div>
                <div id="totalP1">0</div><div id="totalP2">0</div><div id="totalP3">0</div><div id="totalP4">0</div>
            </div>
        </div>

        <div class="p-4 bg-gray-50 flex justify-between items-center">
            <div class="text-[10px] text-gray-400">â€»0ä»¥å¤–ã®è¡Œã‚’ä¿å­˜ã—ã¾ã™</div>
            <button onclick="saveSheet()" class="bg-green-600 text-white px-8 py-2 rounded-full font-bold shadow-lg active:scale-95 transition">ã‚·ãƒ¼ãƒˆä¿å­˜</button>
        </div>
    </div>

    <div class="max-w-2xl mx-auto">
        <h2 class="font-bold text-gray-600 mb-2 px-2 flex items-center gap-2">
            <span>ğŸ“… éå»ã®å¯¾æˆ¦å±¥æ­´</span>
            <button onclick="loadHistory()" class="text-[10px] bg-white border px-2 py-0.5 rounded shadow-sm">æ›´æ–°</button>
        </h2>
        <div id="historyList" class="grid grid-cols-1 gap-2 px-2">
            </div>
    </div>

    <script>
        const repo = "921yyyyy/mahjong-score";
        const path = "data.json";

        // --- åˆæœŸåŒ–: 8è¡Œã®å…¥åŠ›æ¬„ã‚’ç”Ÿæˆ ---
        const scoreRows = document.getElementById('scoreRows');
        for (let i = 1; i <= 8; i++) {
            const row = document.createElement('div');
            row.className = 'score-grid grid gap-1';
            row.innerHTML = `
                <div class="flex items-center justify-center text-xs bg-gray-200 rounded font-mono">${i}</div>
                <input type="number" class="p1 r${i} w-full border text-center text-sm p-1.5 rounded focus:ring-1 focus:ring-green-500 outline-none" oninput="calcTotals()">
                <input type="number" class="p2 r${i} w-full border text-center text-sm p-1.5 rounded focus:ring-1 focus:ring-green-500 outline-none" oninput="calcTotals()">
                <input type="number" class="p3 r${i} w-full border text-center text-sm p-1.5 rounded focus:ring-1 focus:ring-green-500 outline-none" oninput="calcTotals()">
                <input type="number" class="p4 r${i} w-full border text-center text-sm p-1.5 rounded focus:ring-1 focus:ring-green-500 outline-none" oninput="calcTotals()">
            `;
            scoreRows.appendChild(row);
        }

        function calcTotals() {
            [1,2,3,4].forEach(p => {
                const sum = Array.from(document.querySelectorAll(`.p${p}`)).reduce((a, b) => a + (parseInt(b.value) || 0), 0);
                const el = document.getElementById(`totalP1 totalP2 totalP3 totalP4`.split(' ')[p-1]);
                el.innerText = (sum > 0 ? '+' : '') + sum;
                el.className = sum >= 0 ? 'text-blue-600' : 'text-red-500';
            });
        }

        function clearBoard() {
            if(!confirm("ãƒœãƒ¼ãƒ‰ã‚’ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
            document.querySelectorAll('#scoreRows input').forEach(i => i.value = '');
            document.getElementById('setName').value = '';
            calcTotals();
        }

        // --- OCRå‡¦ç† ---
        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const st = document.getElementById('status');
            st.classList.remove('hidden');
            const { data: { text } } = await Tesseract.recognize(file, 'eng');
            const nums = text.match(/-?\d+/g)?.map(Number) || [];
            document.querySelectorAll('#scoreRows input').forEach((inp, idx) => {
                if (idx < nums.length) inp.value = nums[idx];
            });
            st.classList.add('hidden');
            calcTotals();
        });

        // --- GitHubä¿å­˜ ---
        async function saveSheet() {
            const token = prompt("GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›");
            if (!token) return;
            const setName = document.getElementById('setName').value || new Date().toLocaleDateString();
            const rows = [];
            for (let i = 1; i <= 8; i++) {
                const vals = Array.from(document.querySelectorAll(`.r${i}`)).map(el => parseInt(el.value) || 0);
                if (vals.some(v => v !== 0)) rows.push(vals);
            }
            const newSheet = { id: Date.now(), date: new Date().toLocaleString('ja-JP'), name: setName, data: rows };
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    headers: { "Authorization": `token ${token}` }
                });
                const fData = await res.json();
                let content = JSON.parse(decodeURIComponent(escape(atob(fData.content))));
                content.push(newSheet);
                await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: "Save sheet",
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
                        sha: fData.sha
                    })
                });
                alert("ä¿å­˜å®Œäº†ï¼");
                loadHistory();
            } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }

        // --- å±¥æ­´èª­ã¿è¾¼ã¿ã¨å†ç¾ ---
        async function loadHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = "<p class='text-xs text-center p-4'>ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</p>";
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`);
                const fData = await res.json();
                const data = JSON.parse(decodeURIComponent(escape(atob(fData.content))));
                
                list.innerHTML = data.reverse().map(sheet => {
                    const totals = [0,0,0,0];
                    sheet.data.forEach(r => r.forEach((v, i) => totals[i] += v));
                    return `
                        <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-green-600 flex justify-between items-center active:bg-gray-50" onclick='viewSheet(${JSON.stringify(sheet)})'>
                            <div class="flex-1">
                                <div class="text-[10px] text-gray-400">${sheet.date}</div>
                                <div class="text-sm font-bold">${sheet.name}</div>
                                <div class="flex gap-2 mt-1">
                                    ${totals.map(t => `<span class="text-[10px] ${t>=0?'text-blue-500':'text-red-400'} font-mono">${t>=0?'+':''}${t}</span>`).join('')}
                                </div>
                            </div>
                            <div class="text-gray-300">â¯</div>
                        </div>
                    `;
                }).join('');
            } catch (e) { list.innerHTML = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼"; }
        }

        // å±¥æ­´ã‚’ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã«ãƒœãƒ¼ãƒ‰ã«å†ç¾ã™ã‚‹
        window.viewSheet = function(sheet) {
            if(!confirm("é¸æŠã—ãŸã‚·ãƒ¼ãƒˆã‚’ãƒœãƒ¼ãƒ‰ã«å±•é–‹ã—ã¾ã™ã‹ï¼Ÿï¼ˆç¾åœ¨ã®å…¥åŠ›ã¯æ¶ˆãˆã¾ã™ï¼‰")) return;
            document.getElementById('setName').value = sheet.name;
            document.querySelectorAll('#scoreRows input').forEach(i => i.value = ''); // ä¸€æ—¦ã‚¯ãƒªã‚¢
            sheet.data.forEach((rowVals, rowIdx) => {
                rowVals.forEach((val, pIdx) => {
                    document.querySelector(`.p${pIdx+1}.r${rowIdx+1}`).value = val;
                });
            });
            calcTotals();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.onload = loadHistory;
    </script>
</body>
</html>
