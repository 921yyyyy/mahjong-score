<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STATS | Professional</title>
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #070d1c; color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .gridjs-container { padding: 0; color: #1e293b; }
        .gridjs-wrapper { border-radius: 0; border: none; overflow-x: auto !important; }
        .gridjs-th {
            background-color: #041e42 !important; color: #ffffff !important;
            text-transform: uppercase; font-size: 9px !important;
            padding: 12px 5px !important; text-align: center !important;
            min-width: 75px;
        }
        .gridjs-td:first-child, .gridjs-th:first-child {
            position: sticky !important; left: 0; z-index: 10; min-width: 90px !important;
        }
        .gridjs-th:first-child { background-color: #041e42 !important; }
        .gridjs-td:first-child { background-color: #ffffff !important; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .gridjs-td {
            background-color: #ffffff !important; color: #1e293b !important;
            font-weight: 800 !important; font-size: 11px !important;
            border-bottom: 1px solid #e2e8f0 !important; padding: 12px 5px !important;
            text-align: center !important;
        }
        .gridjs-tr:nth-child(odd) .gridjs-td { background-color: #f8fafc !important; }
        .gridjs-tr:nth-child(odd) .gridjs-td:first-child { background-color: #f8fafc !important; }
        .gridjs-sort { background-color: transparent !important; }
        button.gridjs-sort-neutral, button.gridjs-sort-asc, button.gridjs-sort-desc { filter: brightness(0) invert(1); opacity: 0.8; }
        .pts-positive { color: #1d4ed8 !important; }
        .pts-negative { color: #be123c !important; }
        .tab-button { transition: all 0.3s ease; position: relative; opacity: 0.4; font-weight: 900; text-transform: uppercase; }
        .tab-button.active { opacity: 1; color: #f97316; }
        .tab-button.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 20px; height: 3px; background: #f97316; border-radius: 2px;
        }
        .gridjs-search-input { background-color: #1e293b !important; border: 1px solid #334155 !important; color: white !important; border-radius: 8px !important; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body class="pb-24">
    <div class="max-w-4xl mx-auto">
        <header class="p-6 bg-gradient-to-b from-[#041e42] to-[#070d1c] border-b border-orange-500/30">
            <h1 class="text-2xl font-black italic text-white uppercase mb-6 leading-none tracking-tighter">Analysis Center</h1>
            <div class="flex space-x-8">
                <button onclick="changeTab('match')" id="btn-match" class="tab-button active text-xs tracking-widest">Match</button>
                <button onclick="changeTab('session')" id="btn-session" class="tab-button text-xs tracking-widest">Session</button>
            </div>
        </header>
        <div id="mlb-grid-container" class="bg-white min-h-[400px]"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js" defer></script>
    <div id="player-modal" class="fixed inset-0 z-50 bg-[#070d1c] overflow-y-auto hidden">
    <div class="sticky top-0 bg-[#070d1c]/90 backdrop-blur-md p-4 border-b border-white/10 flex justify-between items-center">
        <div>
            <span class="text-[10px] text-orange-500 font-bold uppercase tracking-widest">Player Profile</span>
            <h2 id="modal-player-name" class="text-2xl font-black italic uppercase tracking-tighter">PLAYER NAME</h2>
        </div>
        <button onclick="closePlayerModal()" class="text-slate-400 hover:text-white bg-white/5 w-10 h-10 rounded-full flex items-center justify-center font-bold">×</button>
    </div>
    
    <div class="p-4 space-y-8">
        <div class="grid grid-cols-3 gap-2">
            <div class="bg-white/5 p-3 rounded border border-white/5 text-center">
                <span class="text-[8px] text-slate-500 block uppercase">Match Avg</span>
                <span id="stat-match-avg" class="text-lg font-black italic text-white">-</span>
            </div>
            <div class="bg-white/5 p-3 rounded border border-white/5 text-center">
                <span class="text-[8px] text-slate-500 block uppercase">Sess Avg</span>
                <span id="stat-sess-avg" class="text-lg font-black italic text-white">-</span>
            </div>
            <div class="bg-white/5 p-3 rounded border border-white/5 text-center">
                <span class="text-[8px] text-slate-500 block uppercase">Chips/G</span>
                <span id="stat-chips-avg" class="text-lg font-black italic text-orange-500">-</span>
            </div>
        </div>

       <div class="space-y-6">
    <div class="bg-white/5 p-4 rounded-xl border border-white/10">
        <h3 class="text-[9px] font-black text-blue-400 uppercase tracking-[0.2em] mb-4">Last 10 Matches Trend</h3>
        <div class="h-[200px] relative">
            <canvas id="matchChart"></canvas>
        </div>
    </div>

    <div class="bg-white/5 p-4 rounded-xl border border-white/10">
        <h3 class="text-[9px] font-black text-orange-500 uppercase tracking-[0.2em] mb-4">Last 10 Sessions Trend</h3>
        <div class="h-[200px] relative">
            <canvas id="sessChart"></canvas>
        </div>
    </div>
</div>

</div>

    <script src="navbar.js" defer></script>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>

<script>
    // グローバル変数の定義
    const S_URL = 'https://zekfibkimvsfbnctwzti.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpla2ZpYmtpbXZzZmJuY3R3enRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODU5NjYsImV4cCI6MjA4NDE2MTk2Nn0.AjW_4HvApe80USaHTAO_P7WeWaQvPo3xi3cpHm4hrFs';
    let sb;
    let gridInstance = null;
    let matchChartObj = null;
    let sessChartObj = null;

    // 以前のトラブル解決策：DOMContentLoadedで確実に初期化
    document.addEventListener('DOMContentLoaded', async () => {
        // Supabaseの初期化をここで行う
        if (window.supabase) {
            sb = window.supabase.createClient(S_URL, S_KEY);
        } else {
            console.error("Supabase library not loaded");
            return;
        }

        // 初回レンダリング
        await renderStats('match');
    });

    async function renderStats(mode) {
        const container = document.getElementById('mlb-grid-container');
        if (!container) return;

        // 既存Gridの破棄
        if (gridInstance) {
            gridInstance.destroy();
        }
        container.innerHTML = `<div class='p-10 text-slate-400 text-center font-bold animate-pulse'>LOADING ${mode.toUpperCase()}...</div>`;

        try {
            const tableName = mode === 'match' ? 'game_results' : 'set_summaries';
            const { data, error } = await sb.from(tableName).select('*');

            if (error || !data) throw error;

            // --- データ集計ロジック（ここは変更なし） ---
            const stats = {};
            data.forEach(r => {
                const n = r.player_name || 'Unknown';
                const rk = mode === 'match' ? Number(r.rank || 0) : Number(r.final_rank || 0);
                const sc = mode === 'match' ? Number(r.score || 0) : Number(r.total_score || 0);
                if(!stats[n]) stats[n] = { n, g:0, sumR:0, pts:0, f:0, s:0, l:0, mx:-999 };
                stats[n].g++;
                stats[n].sumR += rk;
                stats[n].pts += sc;
                if(rk === 1) stats[n].f++;
                if(rk === 2) stats[n].s++;
                if(rk === 4) stats[n].l++;
                if(sc > stats[n].mx) stats[n].mx = sc;
            });

            const tableData = Object.values(stats).sort((a,b) => b.pts - a.pts).map(p => [
                p.n, p.g, (p.sumR/p.g).toFixed(2), p.f, 
                ((p.f/p.g)*100).toFixed(1)+'%', 
                (((p.f+p.s)/p.g)*100).toFixed(1)+'%',
                ((1-(p.l/p.g))*100).toFixed(1)+'%', 
                p.mx,
                gridjs.html(`<span class="${p.pts>0?'pts-positive':'pts-negative'}">${p.pts>0?'+'+p.pts:p.pts}</span>`)
            ]);

            const headers = mode === 'match' 
                ? ["PLAYER", "G", "AVG", "1ST", "TOP%", "REN%", "L-ESC%", "MAX", "PTS"]
                : ["PLAYER", "S-G", "S-AVG", "S-1ST", "S-TOP%", "S-REN%", "S-ESC%", "S-MAX", "S-PTS"];

            container.innerHTML = '';

            // Grid.jsの初期化
            gridInstance = new gridjs.Grid({
                columns: headers.map((h, index) => ({ 
                    name: h, 
                    sort: { enabled: true },
                    formatter: (cell) => {
                        if (index === 0) {
                            return gridjs.html(`<div onclick="showPlayerDetail('${cell}')" class="text-blue-600 underline cursor-pointer font-black italic">${cell}</div>`);
                        }
                        return cell;
                    }
                })),
                data: tableData,
                search: true,
                fixedHeader: true,
                style: { table: { 'min-width': '650px' } },
                language: { 'search': { 'placeholder': '選手名検索...' } }
            });

            gridInstance.render(container);

        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class='p-10 text-red-500 font-bold'>ERROR: ${e.message}</div>`;
        }
    }

    // タブ切り替え関数をグローバルに
    window.changeTab = async function(mode) {
        document.getElementById('btn-match').classList.toggle('active', mode === 'match');
        document.getElementById('btn-session').classList.toggle('active', mode === 'session');
        await renderStats(mode);
    };

    // --- 詳細モーダル関連の関数（showPlayerDetail, renderChart 等は前回のコードをそのまま維持） ---
    // ※ ここに以前お送りした showPlayerDetail と renderChart, closePlayerModal を追加してください

    // --- プレイヤー詳細モーダル用ロジック ---
    window.showPlayerDetail = async function(playerName) {
        const modal = document.getElementById('player-modal');
        document.getElementById('modal-player-name').innerText = playerName;
        modal.classList.remove('hidden');

        try {
            // Matchトレンド (直近10件)
            const { data: mData } = await sb.from('game_results')
                .select('rank')
                .eq('player_name', playerName)
                .order('created_at', { ascending: false })
                .limit(10);

            // Sessionトレンド (直近10件)
            const { data: sData } = await sb.from('set_summaries')
                .select('total_score, tips')
                .eq('player_name', playerName)
                .order('created_at', { ascending: false })
                .limit(10);

            const matchRanks = mData ? mData.map(d => d.rank).reverse() : [];
            const sessScores = sData ? sData.map(d => d.total_score).reverse() : [];

            // モーダル内スタッツ更新
            if (matchRanks.length > 0) {
                const matchAvg = (matchRanks.reduce((a, b) => a + b, 0) / matchRanks.length).toFixed(2);
                document.getElementById('stat-match-avg').innerText = matchAvg;
            }
            document.getElementById('stat-sess-avg').innerText = sData && sData[0] ? sData[0].total_score : 0;
            
            // グラフ描画
            renderChart('matchChart', matchRanks, '#3b82f6', 'Match Rank', true);
            renderChart('sessChart', sessScores, '#f97316', 'Session Pts', false);

        } catch (e) { console.error('Error fetching details:', e); }
    };

    function renderChart(canvasId, data, color, label, isRank) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        if (canvasId === 'matchChart' && matchChartObj) matchChartObj.destroy();
        if (canvasId === 'sessChart' && sessChartObj) sessChartObj.destroy();

        const newChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((_, i) => i + 1),
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '33',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointBackgroundColor: color,
                    borderWidth: 3
                }]
            },
            // renderChart 関数の options 部分を微調整
options: {
    responsive: true,
    maintainAspectRatio: false, // これが重要！
    scales: {
        y: {
            reverse: isRank,
            // 順位グラフ(Match)の場合の調整
            min: isRank ? 0.5 : undefined, // 1より少し上に余裕を持たせる
            max: isRank ? 4.5 : undefined, // 4より少し下に余裕を持たせる
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { 
                color: '#94a3b8', 
                stepSize: 1,
                // 0.5とか4.5を表示しないようにする
                callback: function(value) {
                    if (value % 1 === 0) return value;
                }
            }
        },
        x: { display: false }
    },
    // ...以下同じ

                plugins: { legend: { display: false } }
            }
        });

        if (canvasId === 'matchChart') matchChartObj = newChart;
        if (canvasId === 'sessChart') sessChartObj = newChart;
    }

    window.closePlayerModal = () => {
        document.getElementById('player-modal').classList.add('hidden');
    };
</script>


</body>
</html>
